<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>Lab 5: Surface Map Analysis</title>

    <!-- Shared styles -->
    <link href="shared/styles/common.css" rel="stylesheet" />
    <link href="shared/styles/lab-styles.css" rel="stylesheet" />
    <link href="shared/styles/canvas-tools.css" rel="stylesheet" />

    <!-- Lab 3 + Lab 4 goodies: tokens, progress, collapsibles, inline inputs (no zoom) -->
    <style>
      :root {
        --indigo: #667eea;
        --purple: #764ba2;
        --google-blue: #4285f4;
        --surface: #f0f4ff;
        --ink-700: #3a4a7a;
        --fs-h1: clamp(1.25rem, 2.2vw + 1rem, 1.75rem);
        --fs-body: clamp(0.95rem, 0.7vw + 0.8rem, 1rem);
        --pad-card: clamp(14px, 2vw, 20px);
        --pad-header-y: 14px;
        --hit-area: 44px;
        --inline-lh: 1.5;
      }

      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial,
          sans-serif;
        color: var(--ink-700);
        background: #fff;
        font-size: var(--fs-body);
        line-height: 1.5;
        -webkit-tap-highlight-color: transparent;
      }

      .container {
        max-width: 960px;
        margin: 80px auto 72px;
        padding: 0 16px;
      }
      .header h1 {
        margin: 0 0 6px 0;
        font-size: var(--fs-h1);
        color: #ffffff;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.25);
      }
      .header p {
        margin: 0;
        color: #e8ebff;
        font-weight: 600;
        font-size: 0.98em;
        opacity: 0.95;
      }

      /* Progress (blurred) */
      .progress-indicator {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: saturate(120%) blur(4px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        padding: 8px 0;
        padding-top: env(safe-area-inset-top);
      }
      .progress-bar {
        width: 100%;
        height: 8px;
        background: #e0e0e0;
        overflow: hidden;
      }
      .progress-fill {
        height: 8px;
        background: linear-gradient(
          90deg,
          var(--indigo) 0%,
          var(--purple) 100%
        );
        width: 0%;
        transition: width 0.3s ease;
        display: block;
      }

      .section {
        margin: 0 0 16px 0;
      }

      /* Collapsibles */
      .collapsible-container {
        border-radius: 12px;
        overflow: hidden;
        margin: 0 0 16px 0;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        background: var(--surface);
        border: 1px solid #dfe7ff;
      }
      .collapsible-header {
        margin: 0;
        padding: max(var(--pad-header-y), 12px) 48px
          max(var(--pad-header-y), 12px) var(--pad-card);
        cursor: pointer;
        user-select: none;
        position: relative;
        font-weight: 800;
        color: #1f3b82;
        background: var(--surface);
        min-height: var(--hit-area);
        display: flex;
        align-items: center;
      }
      .collapsible-header:hover {
        filter: brightness(0.98);
      }
      .collapsible-header::after {
        content: "‚ñº";
        position: absolute;
        right: 16px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 0.95em;
        color: #6a6a6a;
        transition: transform 0.2s ease;
      }
      .collapsible-header.is-collapsed::after {
        transform: translateY(-50%) rotate(-90deg);
      }
      .stripe-blue {
        border-left: 4px solid var(--google-blue);
      }
      .stripe-indigo {
        border-left: 4px solid var(--indigo);
      }
      .collapsible-content {
        display: block;
        background: var(--surface);
        padding: var(--pad-card);
        border-top: 1px solid #e5ecff;
      }
      .collapsible-content.is-collapsed {
        display: none;
      }

      /* Inline inputs from Lab 3 (optional for inline Qs) */
      .fill-in-line {
        display: inline-flex;
        align-items: baseline;
        gap: 0.3rem 0.25rem;
        margin: 6px 0;
        font-size: 1.05em;
        line-height: var(--inline-lh);
      }
      .inline-input {
        display: inline-block;
        width: clamp(6ch, 22vw, 10ch);
        margin: 0 3px;
        padding: 0 0.55em;
        text-align: center;
        border: 2px solid #667eea;
        border-radius: 6px;
        background: #fff;
        font-weight: 600;
        color: #1e3c72;
        height: calc(var(--inline-lh) * 1em);
        line-height: var(--inline-lh);
        box-sizing: content-box;
      }
      .inline-input:focus {
        border: 2px solid #764ba2;
        background: #f8f9fa;
        box-shadow: 0 0 0 3px rgba(118, 75, 162, 0.1);
        outline: none;
      }
      .inline-dropdown {
        display: inline-flex;
        padding: 0 0.3em;
        border: 2px solid #667eea;
        border-radius: 3px;
        background: transparent;
        font-weight: 600;
        color: #1e3c72;
        cursor: pointer;
        font-family: inherit;
        font-size: 1em;
        height: calc(var(--inline-lh) * 1em);
        line-height: var(--inline-lh);
      }
      .inline-dropdown:focus {
        border-color: #764ba2;
        background: #f8f9fa;
        box-shadow: none;
      }

      /* Responsive tweaks */
      @media (max-width: 900px) {
        .container {
          margin-top: 76px;
        }
      }
      @media (max-width: 700px) {
        .container {
          padding: 0 12px;
        }
        .collapsible-container {
          border-radius: 10px;
        }
        /* Ensure images scale well on tablets and mobile */
        .diagram-container img {
          width: 100%;
          max-width: 100%;
          height: auto;
        }
      }
      @media (max-width: 480px) {
        .container {
          margin-bottom: 84px;
        }
        .collapsible-header {
          padding-left: 14px;
          padding-right: 42px;
        }
        /* Extra responsive boost for small phones */
        .diagram-container {
          padding: 12px;
          margin: 12px 0;
        }
        .diagram-container img {
          width: 100%;
          height: auto;
          margin: 10px auto;
        }
      }
      @media (max-width: 420px) {
        :root {
          --inline-lh: 1.45;
        }
        .inline-input,
        .inline-dropdown,
        .fill-in-line {
          font-size: 0.95em;
        }
      }
      @media (prefers-reduced-motion: reduce) {
        * {
          animation: none !important;
          transition: none !important;
        }
      }
    </style>
  </head>

  <body>
    <!-- Progress -->
    <div class="progress-indicator">
      <div class="progress-bar">
        <div class="progress-fill" id="progressBar"></div>
      </div>
    </div>

    <div class="container">
      <div class="header">
        <h1>üå¶Ô∏è Lab 5: Surface Map Analysis</h1>
        <p>Understanding Station Models and Weather Maps (30 Points)</p>
      </div>

      <!-- For This Lab (collapsible) -->
      <div class="section">
        <div class="collapsible-container">
          <div
            class="collapsible-header stripe-indigo"
            onclick="toggleCollapsible(this)"
          >
            üìã For This Lab
          </div>
          <div class="collapsible-content">
            <div class="info-box info-box--instructions">
              <h3 class="info-box-title">Instructions</h3>
              <ol class="styled-list">
                <li>
                  Review the introduction and station model examples carefully
                </li>
                <li>
                  Complete all sections including station decoding, map
                  analysis, and drawing exercises
                </li>
                <li>
                  Monitor your progress using the progress bar at the top of the
                  page
                </li>
                <li>Your work is automatically saved as you type</li>
                <li>
                  <strong>Save all 3 images</strong> using the provided save
                  buttons before downloading your final file
                </li>
                <li>
                  When complete, click
                  <strong>"Download file for Canvas Submission"</strong>
                </li>
                <li>
                  Locate and upload these files to Canvas:
                  <ul class="styled-list styled-list--nested">
                    <li><em>Lab05_SurfaceMapAnalysis.txt</em> (answer file)</li>
                    <li><em>Lab05_StationModel.png</em> (Image 1)</li>
                    <li><em>Lab05_Isodrosotherm_45F.png</em> (Image 2)</li>
                    <li><em>Lab05_Isotherms.png</em> (Image 3)</li>
                  </ul>
                </li>
              </ol>
              <p class="info-box-tip">
                <strong>üí° Tip:</strong> This lab requires both a text file AND
                3 saved images. Don‚Äôt forget to save each drawing before moving
                to the next section!
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Introduction (collapsible) -->
      <div class="section">
        <div class="collapsible-container">
          <div
            class="collapsible-header stripe-indigo"
            onclick="toggleCollapsible(this)"
          >
            üìö Introduction
          </div>
          <div class="collapsible-content">
            <div class="intro-box">
              <p>
                Every hour weather data is collected at more than 10,000 surface
                weather stations around the world and disseminated to one of
                three
                <strong>World Meteorological Centers</strong>, in Melbourne,
                Australia; Moscow, Russia; or Washington, D.C. where
                synoptic-scale maps are generated.
                <strong>Synoptic</strong> means coincident in time, and a
                synoptic map is a map of weather conditions for a specific time.
              </p>
              <p>
                Traditionally, time printed on many weather maps is
                <strong>Greenwich Mean Time (GMT)</strong>, also called
                Coordinated Universal Time, the time at the prime meridian.
              </p>
            </div>

            <div class="intro-box">
              <p>
                Weather maps are most useful when their information is analyzed
                in some fashion. Highlighting the spatial patterns of specific
                variables‚Äîsuch as temperature, dew point, pressure, and winds‚Äîis
                a first step in weather analysis. We often use
                <strong>isolines</strong> (lines of constant value) for this
                purpose.
              </p>
              <h3>Types of Isolines:</h3>
              <ul>
                <li>
                  <strong>Isotherms:</strong> Lines of constant temperature
                </li>
                <li>
                  <strong>Isobars:</strong> Lines of constant barometric
                  pressure
                </li>
                <li>
                  <strong>Isodrosotherms:</strong> Lines of constant dew point
                </li>
              </ul>
            </div>

            <div class="info-box">
              <strong>üìè Standards for Constructing Isolines:</strong>
              <ul class="styled-list styled-list--nested">
                <li>
                  Because isolines are lines of constant value, they do not
                  cross.
                </li>
                <li>
                  Isolines should be relatively smooth. Sharp breaks are rare.
                </li>
                <li>
                  Use fixed intervals (e.g., 4 mb, centered on 1000 mb, for
                  pressure).
                </li>
                <li>
                  For temperature and dew point, 5¬∞F intervals are commonly
                  used.
                </li>
                <li>
                  Label isolines near map edges; for closed loops, label within
                  a small break.
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- Section 1: Decoding Station Models -->
      <div class="section">
        <div class="collapsible-container">
          <div
            class="collapsible-header stripe-blue"
            onclick="toggleCollapsible(this)"
          >
            Section 1: Decoding Station Models
          </div>
          <div class="collapsible-content">
            <div class="intro-box">
              <p>
                The <strong>station model</strong> is a standardized way to
                display multiple weather observations from a single location on
                a weather map. Below is a station model that you need to decode.
              </p>
            </div>

            <h3>Question 1: Decode Station Model (4 pts)</h3>
            <p>
              <strong>Instructions:</strong> Decode the station model in Figure
              1 below by selecting the correct values for each weather
              parameter.
            </p>

            <div class="diagram-container">
              <img
                src="Fig1.png"
                alt="Station Model"
                style="background-color: white"
              />
              <p class="image-caption">Figure 1: Station Model Diagram</p>
            </div>

            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th width="50%">Parameter</th>
                    <th width="50%">Value</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Sea-level Pressure:</td>
                    <td>
                      <select id="q1_pressure">
                        <option value="">Select...</option>
                        <option value="1024">1024</option>
                        <option value="102.4">102.4</option>
                        <option value="1002.4">1002.4</option>
                        <option value="37">37</option>
                      </select>
                    </td>
                  </tr>
                  <tr>
                    <td>Temperature:</td>
                    <td>
                      <select id="q1_temp">
                        <option value="">Select...</option>
                        <option value="37">37</option>
                        <option value="21">21</option>
                        <option value="24">24</option>
                      </select>
                    </td>
                  </tr>
                  <tr>
                    <td>Dew-point Temperature:</td>
                    <td>
                      <select id="q1_dewpoint">
                        <option value="">Select...</option>
                        <option value="37">37</option>
                        <option value="21">21</option>
                        <option value="24">24</option>
                      </select>
                    </td>
                  </tr>
                  <tr>
                    <td>Sky Coverage:</td>
                    <td>
                      <select id="q1_sky">
                        <option value="">Select...</option>
                        <option value="clear">Clear</option>
                        <option value="scattered">Scattered</option>
                        <option value="broken">Broken</option>
                        <option value="overcast">Overcast</option>
                      </select>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <h3>Question 2: Advanced Station Model Decoding (8 pts)</h3>
            <p>
              <strong>Instructions:</strong> This station model includes
              additional weather elements beyond the basic temperature and
              pressure data. Decode all the information displayed.
            </p>

            <div class="diagram-container">
              <img
                src="Fig2.png"
                alt="Station Model"
                style="background-color: white"
              />
              <p class="image-caption">Figure 2: Station Model Diagram</p>
            </div>

            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th width="50%">Parameter</th>
                    <th width="50%">Value</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Current Weather:</td>
                    <td>
                      <select id="q2_weather">
                        <option value="">Select...</option>
                        <option value="snow-light">Light Snow</option>
                        <option value="rain-moderate">Moderate Rain</option>
                        <option value="snow-moderate">Moderate Snow</option>
                        <option value="none">None</option>
                      </select>
                    </td>
                  </tr>
                  <tr>
                    <td>Sea-level Pressure:</td>
                    <td>
                      <select id="q2_pressure">
                        <option value="">Select...</option>
                        <option value="997">997 mb</option>
                        <option value="999.7">999.7 mb</option>
                        <option value="1999.7">1999.7 mb</option>
                        <option value="1013">1013 mb</option>
                      </select>
                    </td>
                  </tr>
                  <tr>
                    <td>Temperature:</td>
                    <td>
                      <select id="q2_temp">
                        <option value="">Select...</option>
                        <option value="31">31¬∞F</option>
                        <option value="27">27¬∞F</option>
                        <option value="24">24¬∞F</option>
                        <option value="32">32¬∞F</option>
                      </select>
                    </td>
                  </tr>
                  <tr>
                    <td>Dew-point Temperature:</td>
                    <td>
                      <select id="q2_dewpoint">
                        <option value="">Select...</option>
                        <option value="18">18¬∞F</option>
                        <option value="24">24¬∞F</option>
                        <option value="21">21¬∞F</option>
                        <option value="27">27¬∞F</option>
                      </select>
                    </td>
                  </tr>
                  <tr>
                    <td>Sky Coverage:</td>
                    <td>
                      <select id="q2_sky">
                        <option value="">Select...</option>
                        <option value="Few">Few</option>
                        <option value="Overcast">Overcast</option>
                        <option value="Clear">Clear</option>
                        <option value="Scattered">Scattered</option>
                      </select>
                    </td>
                  </tr>
                  <tr>
                    <td>Wind Speed:</td>
                    <td>
                      <select id="q2_windspeed">
                        <option value="">Select...</option>
                        <option value="25">25 kt</option>
                        <option value="12.5">12.5 kt</option>
                        <option value="20">20 kt</option>
                        <option value="30">30 kt</option>
                      </select>
                    </td>
                  </tr>
                  <tr>
                    <td>Wind Direction:</td>
                    <td>
                      <select id="q2_winddir">
                        <option value="">Select...</option>
                        <option value="N">N</option>
                        <option value="NE">NE</option>
                        <option value="E">E</option>
                        <option value="SE">SE</option>
                        <option value="S">S</option>
                        <option value="SW">SW</option>
                        <option value="W">W</option>
                        <option value="NW">NW</option>
                      </select>
                    </td>
                  </tr>
                  <tr>
                    <td>Pressure change in last 3 hrs:</td>
                    <td>
                      <select id="q2_pressurechange">
                        <option value="">Select...</option>
                        <option value="-1.1">-1.1 mb</option>
                        <option value="+2">+2 mb</option>
                        <option value="0">0 mb</option>
                        <option value="-0.11">-0.11 mb</option>
                      </select>
                    </td>
                  </tr>
                  <tr>
                    <td>Precipitation Amount:</td>
                    <td>
                      <select id="q2_precipamount">
                        <option value="">Select...</option>
                        <option value="3.1">3.1"</option>
                        <option value="0.11">0.11"</option>
                        <option value="0.31">0.31"</option>
                        <option value="0.41">0.41"</option>
                      </select>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Section 2: Create a Station Model -->
      <div class="section">
        <div class="collapsible-container">
          <div
            class="collapsible-header stripe-indigo"
            onclick="toggleCollapsible(this)"
          >
            Section 2: Create a Station Model
          </div>
          <div class="collapsible-content">
            <p>
              <strong>Instructions:</strong> Use the data below to construct a
              complete station model using the drag-and-drop tool.
            </p>

            <div class="intro-box">
              <h3>Given Data:</h3>
              <ul>
                <li><strong>Current Weather:</strong> Continuous light rain</li>
                <li><strong>Sea-level Pressure:</strong> 1004.5 mb</li>
                <li><strong>Temperature:</strong> 53¬∞F</li>
                <li><strong>Dew-point Temperature:</strong> 51¬∞F</li>
                <li><strong>Sky Coverage:</strong> Completely overcast</li>
                <li><strong>Wind Speed:</strong> 15 knots</li>
                <li><strong>Wind Direction:</strong> NE</li>
              </ul>
            </div>

            <h3>Question 3: Build Station Model (6 pts)</h3>
            <div id="station-model-builder-container"></div>
          </div>
        </div>
      </div>

      <!-- Understanding Isolines -->
      <div class="section">
        <div class="collapsible-container">
          <div
            class="collapsible-header stripe-indigo"
            onclick="toggleCollapsible(this)"
          >
            üìà Understanding Isolines
          </div>
          <div class="collapsible-content">
            <div class="intro-box">
              <p>
                Weather maps are most useful when their information is analyzed
                in some fashion. Highlighting the spatial patterns of specific
                variables‚Äîsuch as temperature, dew point, pressure, and winds‚Äîis
                a first step in weather analysis. We often use
                <strong>isolines</strong> (lines of constant value) for this
                purpose.
              </p>
              <h3>Types of Isolines:</h3>
              <ul>
                <li>
                  <strong>Isotherms:</strong> Lines of constant temperature
                </li>
                <li>
                  <strong>Isobars:</strong> Lines of constant barometric
                  pressure
                </li>
                <li>
                  <strong>Isodrosotherms:</strong> Lines of constant dew point
                </li>
              </ul>
            </div>

            <div class="info-box">
              <strong>üìè Standards for Constructing Isolines:</strong>
              <ul class="styled-list styled-list--nested">
                <li>
                  Because isolines are lines of constant value, they do not
                  cross.
                </li>
                <li>
                  Isolines should be relatively smooth. Sharp breaks are rare.
                </li>
                <li>
                  They should be drawn at fixed intervals. Meteorologists
                  traditionally use 4-mb intervals, centered on 1000 mb, for
                  barometric pressure (e.g., 996 mb, 1000 mb, 1004 mb, etc.).
                </li>
                <li>
                  For temperature and dew point, intervals of 5¬∞F are commonly
                  used.
                </li>
                <li>
                  Isolines should be labeled near the edge of the map. When they
                  form a closed figure, the label is inserted in a small break
                  in the line.
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- Q4: Single Isodrosotherm -->
      <div class="section">
        <div class="collapsible-container">
          <div
            class="collapsible-header stripe-blue"
            onclick="toggleCollapsible(this)"
          >
            üßÆ Question 4: Drawing Isodrosotherms (4 pts)
          </div>
          <div class="collapsible-content">
            <p>
              <strong>Instructions:</strong> Annotate the image below by drawing
              the <strong>45¬∞F isodrosotherm</strong>. Use interpolation to
              determine where the line should be drawn based on the dew point
              values at each station.
            </p>

            <div class="curve-widget-wrapper">
              <div class="stage">
                <img
                  id="bg-img-single"
                  src="Lab-5 Isodrosotherm blank.png"
                  alt="Map with dew point data"
                />
                <canvas
                  id="draw-canvas-single"
                  style="left: 3px; top: 1px; width: 100%; height: 100%"
                ></canvas>
              </div>
              <p class="hint">
                Click to add points, drag dots to move, and right-click to
                remove. ‚ÄúSave‚Äù will merge your line onto the map image.
              </p>
              <div class="controls">
                <button id="undo-last-btn-single" class="btn">
                  Undo Last Point
                </button>
                <button id="undo-all-btn-single" class="btn">
                  Clear All Points
                </button>
                <button id="save-btn-single" class="btn-save">
                  Save as PNG
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Q5: Multiple Lines -->
      <div class="section">
        <div class="collapsible-container">
          <div
            class="collapsible-header stripe-blue"
            onclick="toggleCollapsible(this)"
          >
            üß© Question 5: Drawing Multiple Isotherms (8 pts)
          </div>
          <div class="collapsible-content">
            <p>
              <strong>Instructions:</strong> Using the surface map below, draw
              the <strong>35¬∞F, 40¬∞F, and 45¬∞F isotherms</strong> and the
              <strong>45¬∞F isodrosotherm (Td)</strong>. Remember to label each
              clearly and use smooth lines that follow the gradients.
            </p>

            <div class="curve-widget-wrapper">
              <div class="stage">
                <img
                  id="bg-img-multi"
                  src="BlankAnalysis.png"
                  alt="Background analysis map"
                />
                <canvas
                  id="draw-canvas-multi"
                  style="left: 13px; top: -6px"
                ></canvas>
              </div>
              <p class="hint">
                Click to add points and define your line. Drag dots to move.
                Right-click a dot to remove. ‚ÄúSave‚Äù merges your lines with the
                image.
              </p>
              <div class="controls">
                <label for="line-select-multi">Edit Line:</label>
                <select id="line-select-multi">
                  <option value="0" selected>35¬∞ T</option>
                  <option value="1">40¬∞ T</option>
                  <option value="2">45¬∞ T</option>
                  <option value="3">45¬∞ Td</option>
                </select>
                <button id="undo-last-btn-multi" class="btn">Undo Last</button>
                <button id="undo-all-btn-multi" class="btn">Undo All</button>
                <button id="save-btn-multi" class="btn-save">
                  Save as PNG
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Export / Help (uses your shared button styles) -->
      <div class="button-container">
        <button class="btn-success button-flex" onclick="exportAnswers()">
          üì• Download file for Canvas Submission
        </button>
        <button class="btn-clear button-flex" onclick="clearForm()">
          üóëÔ∏è Clear All Answers
        </button>
        <button
          type="button"
          class="btn-help button-flex"
          onclick="window.location.href='mailto:JMartinelli@peru.edu?subject=Lab 5 - Question/Feedback&body=Hi Dr. M,%0D%0A%0D%0AI have a question about Lab 5:%0D%0A%0D%0A'"
        >
          ‚ùì Questions, concerns, feedback, or need help?
        </button>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script type="module" src="lab05-main.js"></script>

    <!-- Lightweight helpers: progress, autosave/restore, collapsibles -->
    <script>
      /* Progress */
      function updateProgress() {
        const inputs = document.querySelectorAll(
          'input[type="text"], input[type="number"], select, textarea'
        );
        let filled = 0;
        inputs.forEach((el) => {
          if ((el.value || "").trim() !== "") filled++;
        });
        const pct = inputs.length ? (filled / inputs.length) * 100 : 0;
        const bar = document.getElementById("progressBar");
        if (bar) bar.style.width = pct + "%";
      }
      document.addEventListener("input", updateProgress);
      document.addEventListener("change", updateProgress);
      document.addEventListener("DOMContentLoaded", updateProgress);

      /* Autosave / restore */
      const STORAGE_KEY = "lab5_progress";
      function saveProgress() {
        const data = { timestamp: new Date().toISOString() };
        document
          .querySelectorAll(
            'input[type="text"], input[type="number"], textarea, select'
          )
          .forEach((el) => {
            if (el.id) data[el.id] = el.value;
          });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      }
      function loadProgress() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (!saved) return;
        const data = JSON.parse(saved);
        Object.keys(data).forEach((k) => {
          const el = document.getElementById(k);
          if (el) el.value = data[k];
        });
      }
      // periodic autosave (30s)
      setInterval(() => {
        const inputs = document.querySelectorAll(
          'input[type="text"], input[type="number"], textarea, select'
        );
        const hasData = Array.from(inputs).some(
          (i) => i.value && i.value.trim()
        );
        if (hasData) saveProgress();
      }, 30000);

      window.addEventListener("load", () => {
        loadProgress();
        updateProgress();
      });
      window.addEventListener("beforeunload", (e) => {
        const inputs = document.querySelectorAll(
          'input[type="text"], input[type="number"], textarea, select'
        );
        const hasData = Array.from(inputs).some(
          (i) => i.value && i.value.trim()
        );
        if (hasData) {
          e.preventDefault();
          e.returnValue = "";
        }
      });

      /* Collapsibles */
      function toggleCollapsible(header) {
        const content = header.nextElementSibling;
        const collapsed = content.classList.toggle("is-collapsed");
        header.classList.toggle("is-collapsed", collapsed);
      }

      // Stubs expected by buttons; real logic lives in lab05-main.js
      window.exportAnswers = window.exportAnswers || function () {};
      window.clearForm = window.clearForm || function () {};
    </script>
  </body>
</html>
